{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.3", "generated_at": "2025-03-24T19:22:58.707029Z", "invocation_id": "f7904498-168a-4d18-9f86-cbca13b1aaa9", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-24T19:22:48.870639Z", "completed_at": "2025-03-24T19:22:48.880405Z"}, {"name": "execute", "started_at": "2025-03-24T19:22:48.880874Z", "completed_at": "2025-03-24T19:22:52.612849Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.743947982788086, "adapter_response": {"_message": "CREATE TABLE (8.0 rows, 8.0 MiB processed)", "code": "CREATE TABLE", "rows_affected": 8, "bytes_processed": 8367819, "bytes_billed": 10485760, "location": "europe-west2", "project_id": "de-projects-453518", "job_id": "831785f3-c926-4a3a-9327-cd3473244a2a", "slot_ms": 3326}, "message": "CREATE TABLE (8.0 rows, 8.0 MiB processed)", "failures": null, "unique_id": "model.web_logs.fraud_detected", "compiled": true, "compiled_code": "-- This query detects 3 different criteria of suspicious activity.\n  -- Criteria 1. IPs with frequency requests more than 3 times during 1 second\n  -- Criteria 2. IPs that use all 3 unique account types per day\n  -- Criteria 3. IPs with session durations and data consumption greater than 75% of users, exhibiting repeated behavior more than once.\n-- If all 3 criteria are fulfilled, the IP address is considered fraudulent.\n\n\n\n\n-- Criteria 1.\nWITH request_frequency AS(\nSELECT\n  ip,\n  COUNT(*) AS request_count,\n  TIMESTAMP_TRUNC(accessed_date, SECOND) AS time_window\nFROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\nGROUP BY 1,3\nHAVING request_count >= 3\nORDER BY request_count DESC\n),\n-- Criteria 2.\naccount_usage AS(\nSELECT \n  ip,\n  DATE(accessed_date) AS request_date,\n  COUNT(DISTINCT account_type) AS unique_accounts,\n  COUNT(*) AS total_requests\nFROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\nGROUP BY ip, request_date\nHAVING unique_accounts > 2\nORDER BY total_requests DESC),\n-- Criteria 3.\nsession_behavior AS(\nWITH quatiles AS(\n  SELECT\n    APPROX_QUANTILES(duration_sec, 100)[OFFSET(75)] AS q75_duration,\n    APPROX_QUANTILES(bytes, 100)[OFFSET(75)] AS q75_bytes\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\n)\nSELECT\n  ip,\n  bytes,\n  q75_bytes,\n  q75_duration,\n  ROUND(AVG(duration_sec)) AS avg_session_duration,\n  COUNT(*) AS session_count\nFROM `de-projects-453518`.`web_logs_dataset`.`web_logs`, quatiles\nGROUP BY ip, bytes, q75_bytes, q75_duration\nHAVING avg_session_duration >q75_duration AND bytes>q75_bytes\n  AND session_count>1\nORDER BY session_count DESC\n)\n-- Uniting results where all 3 criteria are fulfilled.\nSELECT\n  rf.ip,\n  MAX(rf.request_count) AS requests_per_second,\n  MAX (au.total_requests) AS requests_per_day_from_3_account_types,\n  MAX (sb.session_count) AS sessions_q75_duration_bytes\nFROM request_frequency rf\nJOIN account_usage au ON rf.ip = au.ip\nJOIN session_behavior sb ON rf.ip = sb.ip\nGROUP BY rf.ip\nORDER BY requests_per_second DESC", "relation_name": "`de-projects-453518`.`web_logs_dataset`.`fraud_detected`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-24T19:22:52.625410Z", "completed_at": "2025-03-24T19:22:52.633724Z"}, {"name": "execute", "started_at": "2025-03-24T19:22:52.634568Z", "completed_at": "2025-03-24T19:22:53.622275Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.9999725818634033, "adapter_response": {"_message": "CREATE VIEW (0 processed)", "code": "CREATE VIEW", "bytes_processed": 0, "bytes_billed": 0, "location": "europe-west2", "project_id": "de-projects-453518", "job_id": "cefdce03-9e59-49b5-9ce9-3425f8d7b58b", "slot_ms": 0}, "message": "CREATE VIEW (0 processed)", "failures": null, "unique_id": "model.web_logs.RFM_analysis", "compiled": true, "compiled_code": "-- RFM (Recency, Frequency, Monetary) is the core metric for user segmentation in this project.\n  -- Recency: Measures how recently a user logged into the website.\n  -- Frequency: Evaluates how often a user interacts with the website.\n  -- Monetary: Reflects the revenue generated by the user.\n-- Fraudulent traffic is excluded to ensure data integrity. Based on the RFM scores, users are segmented into three value groups: high, mid, and low.\n\n\n\n-- RFM analysis\nWITH max_date_in_dataset AS(\n  SELECT\n    MAX(EXTRACT(DATE FROM accessed_date)) AS max_date\n    FROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\n),\nrfm_analysis AS(\n  SELECT \n  wl.ip,\n  DATE_DIFF(max_date, MAX(EXTRACT(DATE FROM wl.accessed_date)), DAY) AS last_login_days_ago,\n  COUNT (*) AS logins_per_week,\n  ROUND (SUM (wl.sales)) AS spent_per_week\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs` wl\n  LEFT JOIN `de-projects-453518`.`web_logs_dataset`.`fraud_detected` fd ON wl.ip = fd.ip\n  JOIN max_date_in_dataset ON TRUE\n  WHERE fd.ip IS NULL\n  GROUP BY wl.ip, max_date\n  ORDER BY spent_per_week DESC, logins_per_week DESC\n),\n-- user segmentation\npercentile AS (\n  SELECT\n    APPROX_QUANTILES(spent_per_week,100)[OFFSET(63)] AS p63,\n    APPROX_QUANTILES(spent_per_week,100)[OFFSET(57)] AS p57\n  FROM rfm_analysis\n)\nSELECT\n  rfm.*,\n  CASE\n    WHEN\n      (rfm.logins_per_week > 1)\n      AND (rfm.spent_per_week > p.p63)  \n    THEN 'high'\n    WHEN\n      (rfm.logins_per_week = 1)\n      AND (rfm.spent_per_week < p.p57)  \n    THEN 'low'\n    ELSE 'mid'\n  END AS user_value\nFROM rfm_analysis rfm\nJOIN percentile p ON TRUE\nORDER BY 2, rfm.spent_per_week DESC", "relation_name": "`de-projects-453518`.`web_logs_dataset`.`RFM_analysis`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-24T19:22:53.645913Z", "completed_at": "2025-03-24T19:22:53.651202Z"}, {"name": "execute", "started_at": "2025-03-24T19:22:53.651838Z", "completed_at": "2025-03-24T19:22:57.898878Z"}], "thread_id": "Thread-6 (worker)", "execution_time": 4.2553558349609375, "adapter_response": {"_message": "CREATE TABLE (81.0 rows, 7.5 MiB processed)", "code": "CREATE TABLE", "rows_affected": 81, "bytes_processed": 7882572, "bytes_billed": 20971520, "location": "europe-west2", "project_id": "de-projects-453518", "job_id": "a2ba283d-a328-4aab-b592-7cbfa6187c70", "slot_ms": 11652}, "message": "CREATE TABLE (81.0 rows, 7.5 MiB processed)", "failures": null, "unique_id": "model.web_logs.user_segmentation", "compiled": true, "compiled_code": "-- This model analyzes user segmentation by RFM category across different countries.\n-- It provides:\n    -- The distribution of user segments (high, mid, low) by country.\n    -- The average age of users within each segment and country.\n    -- The gender breakdown within each segment and country.\n\n\n\nWITH user_attributes AS (\n  SELECT \n    ip,\n    ARRAY_AGG(country ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS country,\n    ARRAY_AGG(age ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS age,\n    ARRAY_AGG(gender ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS gender\nFROM `de-projects-453518`.`web_logs_dataset`.`web_logs` \nGROUP BY 1\n),\nuser_data AS(\nSELECT\n  rfm.ip,\n  ua.country,\n  ua.age,\n  ua.gender,\n  rfm.user_value\nFROM `de-projects-453518`.`web_logs_dataset`.`RFM_analysis` rfm \nLEFT JOIN  user_attributes ua\nON rfm.ip = ua.ip\n),\npercentage AS (\nSELECT\n  country,\n  user_value,\n  COUNT (*) AS count_users,\n  SUM (COUNT (*)) OVER (PARTITION BY country) AS total_users_per_country,\n  ROUND ((COUNT (*) / SUM (COUNT (*)) OVER (PARTITION BY country) *100), 2) AS percentage\nFROM user_data\nGROUP BY country, user_value\nORDER BY country\n),\naggregations AS(\nSELECT\n country,\n user_value,\n  ROUND (AVG (age), 2) AS avg_age,\n  ROUND (SUM (CASE WHEN gender = 'Male' THEN 1 END) / COUNT (CASE WHEN gender IS NOT NULL THEN 1 END) *100, 2) AS percentage_male,\n  ROUND (SUM (CASE WHEN gender = 'Female' THEN 1 END) / COUNT (CASE WHEN gender IS NOT NULL THEN 1 END) *100, 2) AS percentage_female\nFROM user_data \nGROUP BY country, user_value \nORDER BY country\n)\nSELECT \n  p.country,\n  p.user_value,\n  p.percentage AS user_value_share_per_country,\n  a.avg_age,\n  a.percentage_male,\n  a.percentage_female\nFROM percentage p\nJOIN aggregations a\nUSING (country, user_value)\nORDER BY 1", "relation_name": "`de-projects-453518`.`web_logs_dataset`.`user_segmentation`", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-24T19:22:53.639180Z", "completed_at": "2025-03-24T19:22:53.682163Z"}, {"name": "execute", "started_at": "2025-03-24T19:22:53.683480Z", "completed_at": "2025-03-24T19:22:58.696612Z"}], "thread_id": "Thread-5 (worker)", "execution_time": 5.06018328666687, "adapter_response": {"_message": "CREATE TABLE (3.0 rows, 8.0 MiB processed)", "code": "CREATE TABLE", "rows_affected": 3, "bytes_processed": 8367945, "bytes_billed": 20971520, "location": "europe-west2", "project_id": "de-projects-453518", "job_id": "748eb3a7-a589-42cc-935b-09ac1d2f763a", "slot_ms": 8916}, "message": "CREATE TABLE (3.0 rows, 8.0 MiB processed)", "failures": null, "unique_id": "model.web_logs.user_behavior_by_account_type", "compiled": true, "compiled_code": "-- The model calculates business indicators for each type of account:\n    -- LTV (Lifetime value). The average revenue per user over the entire lifecycle of a user.\n    -- ARPU (Average revenue per user). Average revenue per user per day.\n    -- Retention rate. The percentage of users who return to the site within 7 days of their first login. \n    -- Refund rate. The share of returned funds among the revenue.\n-- Fraudulent traffic is excluded for the purity of statistics.\n \n\n\n\nWITH user_attributes AS(\n  SELECT\n    ip,\n    ARRAY_AGG(accessed_date ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS last_accessed_date,\n    ROUND(AVG(duration_sec),2) AS avg_duration,\n    ROUND(AVG(bytes),2) AS avg_bytes,\n    ARRAY_AGG(account_type ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS last_account_type,\n    ROUND(AVG(sales),2) AS avg_sales,\n    ROUND(AVG(refunded_amount),2) AS avg_refunded_amount,\n    ARRAY_AGG(payment_method ORDER BY accessed_date DESC LIMIT 1)[SAFE_OFFSET(0)] AS last_payment_method\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\n  GROUP BY 1\n),\nuser_revenue AS (\n  SELECT\n    rfm.ip,\n    ROUND(SAFE_DIVIDE(SUM(rfm.spent_per_week) / 7, COUNT(rfm.ip)),2) AS ARPU_per_day,\n    COUNT(DISTINCT DATE(accessed_date)) AS active_days,\n    ROUND(SAFE_MULTIPLY(SAFE_DIVIDE(SUM(rfm.spent_per_week) / 7, COUNT(rfm.ip)), COUNT(DISTINCT DATE(accessed_date))),2) AS LTV\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs` wl\n  RIGHT JOIN `de-projects-453518`.`web_logs_dataset`.`RFM_analysis` rfm\n  ON wl.ip = rfm.ip\n  GROUP BY 1\n  ORDER BY 2 DESC\n),\nfirst_visit AS(\n  SELECT\n  ip,\n  MIN(DATE(accessed_date)) AS first_visit\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs`\n  GROUP BY 1\n),\nretention AS(\n  SELECT\n    fv.ip,\n    fv.first_visit,\n    DATE_DIFF(DATE(wl.accessed_date), fv.first_visit, DAY) AS day_number,\n    COUNT(DISTINCT fv.ip) AS retained_users\n  FROM `de-projects-453518`.`web_logs_dataset`.`web_logs` wl\n  JOIN first_visit fv\n  ON wl.ip = fv.ip\n  GROUP BY 1,2,3\n)\nSELECT \n  DISTINCT ua.last_account_type AS account_type,\n  COUNT (ua.ip) AS total_accounts,\n  ROUND(AVG(ur.LTV),2) avg_LTV,\n  ROUND(AVG(ur.ARPU_per_day),2) AS ARPU_per_day,\n  ROUND(SAFE_DIVIDE(COUNT(DISTINCT CASE WHEN r.day_number IN (1,2,3,4,5,6,7) THEN r.ip END), COUNT(DISTINCT r.ip))*100, 2) AS retention_rate_per_week,\n  ROUND(SAFE_DIVIDE(SUM(ua.avg_refunded_amount) * 100, SUM(ua.avg_sales)),2) AS refund_rate\nFROM user_attributes ua\nRIGHT JOIN user_revenue ur\nON ua.ip = ur.ip\nLEFT JOIN retention r\nON ur.ip = r.ip\nGROUP BY 1", "relation_name": "`de-projects-453518`.`web_logs_dataset`.`user_behavior_by_account_type`", "batch_results": null}], "elapsed_time": 10.981021642684937, "args": {"warn_error_options": {"include": [], "exclude": []}, "partial_parse": true, "write_json": true, "indirect_selection": "eager", "print": true, "which": "build", "log_path": "/tmp/kestra-wd/tmp/4gCaPfQBg6OWnylRbCHLA2/logs", "version_check": true, "show": false, "introspect": true, "quiet": false, "favor_state": false, "select": [], "profiles_dir": "/tmp/kestra-wd/tmp/4gCaPfQBg6OWnylRbCHLA2", "require_yaml_configuration_for_mf_time_spines": false, "macro_debugging": false, "show_resource_report": false, "exclude_resource_types": [], "require_explicit_package_overrides_for_builtin_materializations": true, "log_format": "json", "defer": false, "log_level": "info", "exclude": [], "static_parser": true, "invocation_command": "dbt build --log-format json", "log_level_file": "debug", "partial_parse_file_diff": true, "populate_cache": true, "printer_width": 80, "require_batched_execution_for_custom_microbatch_strategy": false, "skip_nodes_if_on_run_start_fails": false, "state_modified_compare_vars": false, "strict_mode": false, "require_nested_cumulative_type_params": false, "send_anonymous_usage_stats": true, "vars": {}, "include_saved_query": false, "require_resource_names_without_spaces": false, "log_format_file": "json", "use_colors": true, "source_freshness_run_project_hooks": false, "log_file_max_bytes": 10485760, "cache_selected_only": false, "project_dir": "/tmp/kestra-wd/tmp/4gCaPfQBg6OWnylRbCHLA2", "state_modified_compare_more_unrendered_values": false, "use_colors_file": true, "resource_types": [], "empty": false, "export_saved_queries": false}}